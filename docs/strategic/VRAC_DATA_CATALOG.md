# VRAC Data Catalog

## Overview

The VRAC (pharmacy surveillance) dataset provides pharmacy sales data from Côte d'Ivoire used as a proxy for workforce health in cocoa-producing regions. Antimalarial sales (ARTEFAN, PLUFENTRINE) correlate with community malaria burden and can inform supply chain intelligence and ESG monitoring.

## Data Sources

| Source | Format | Content |
|--------|--------|---------|
| ETAT_2080QTE*.csv | Top 20 products by quantity | 20 rows per period |
| ETAT_ListeProduitsVendus*.csv | Full product catalog | Full product list with Code, Désignation, Qté vendue |

## Pharmacy Coverage

| Pharmacy | Region | Location | CSV Data |
|----------|--------|----------|----------|
| Grande Pharmacie de Tanda | Gontougo (cocoa) | Tanda | PROLIFE/2080, TANDA/2080, TANDA/ |
| Pharmacie Prolife | Gontougo (cocoa) | Tabagne | PROLIFE/2080 |
| Pharmacie Olympique | Abidjan (urban) | Abidjan | PDF only (OLYMPIQUE/TOP100, OLYMPIQUE/TOTAL) |
| Pharmacie Attobrou | La Mé (cocoa) | La Mé | PDF only (ATTOBROU/) |

## Period Coverage

| Pharmacy | 2022 | 2023 | 2024 | 2025 |
|----------|------|------|------|------|
| Tanda | ✓ | ✓ | ✓ | ✓ |
| Prolife | ✓ | ✓ | ✓ | ✓ |
| Olympique | PDF | PDF | PDF | PDF |
| Attobrou | PDF | PDF | PDF | PDF |

## Data Storage

### Static JSON (Legacy)
Previously, VRAC data was processed from CSV files to static JSON:
- Location: `apps/web/public/data/vrac/processed.json`
- Generated by: `npm run vrac:process`

### Supabase Database (Current)
VRAC data is now stored in Supabase for better scalability, real-time updates, and integration:

**Tables:**
- `agrosoluce.pharmacy_profiles` - Pharmacy metadata (4 pharmacies)
- `agrosoluce.vrac_product_sales` - Individual product sales records
- `agrosoluce.vrac_period_aggregates` - Pre-calculated period summaries for performance
- `agrosoluce.vrac_regional_health_index` - Health metrics by region/period

**Schema Details:**
- All tables use `agrosoluce` schema
- Row Level Security (RLS) enabled with public read access
- Indexes on `pharmacy_id`, `year`, and period columns
- Foreign key relationships ensure data integrity

**Migration:**
1. Process CSV data: `npm run vrac:process`
2. Migrate to database: `npm run vrac:migrate`
3. Migration script: `scripts/vrac/migrateVracToSupabase.ts`

## Processing Pipeline

### Step 1: CSV Processing
Run `npm run vrac:process` (or `npx tsx scripts/vrac/processVracData.ts`)
- Reads CSV files from `VRAC/` folder
- Outputs normalized JSON to `apps/web/public/data/vrac/processed.json`

### Step 2: Database Migration
Run `npm run vrac:migrate` (or `npx tsx scripts/vrac/migrateVracToSupabase.ts`)
- Reads processed JSON
- Inserts pharmacy profiles (4 pharmacies)
- Bulk inserts product sales records
- Calculates and inserts period aggregates
- Calculates and inserts regional health index
- Provides progress reporting and error handling

**Requirements:**
- Supabase credentials in `.env` or `.env.local`
- Environment variables: `VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`

## Product Taxonomy

- **Antimalarial**: ARTEFAN, PLUFENTRINE (artemether/lumefantrine)
- **Antibiotic**: AMOXICILLINE, ACLAV, METRONIDAZOLE, etc.
- **Analgesic**: PARACETAMOL, PARAMED, NOVALGINE, DICLOFENAC, etc.

## API Access

VRAC data can be accessed programmatically through the service layer:

```typescript
import { vracService } from '@/services/vrac/vracService';

// Get all pharmacies
const pharmacies = await vracService.getPharmacyProfiles();

// Get regional health index with filters
const healthIndex = await vracService.getRegionalHealthIndex({
  pharmacyId: 'tanda',
  year: 2025
});

// Get period aggregates
const aggregates = await vracService.getPeriodAggregates('tanda', 2025);

// Get detailed product sales
const sales = await vracService.getProductSales('tanda', 2025);
```

## Use Cases

- Regional health index (antimalarial share by pharmacy/period)
- Cocoa supply intelligence (workforce health proxy)
- ESG/social risk monitoring
- Integration with Marcus Weather, Satelligence, or commodity platforms
- Real-time health data visualization in dashboards
- Historical trend analysis across regions and years
